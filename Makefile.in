##########################################################################
#                                                                        #
#                 ACG development toolkit                                #
#                                                                        #
#                  Copyright 2008 INRIA                                  #
#                                                                        #
#  More information on "http://acg.gforge.loria.fr/"                     #
#  License: CeCILL, see the LICENSE file or "http://www.cecill.info"     #
#  Authors: see the AUTHORS file                                         #
#                                                                        #
#                                                                        #
#                                                                        #
#                                                                        #
#  $Rev::                              $:  Revision of last commit       #
#  $Author::                           $:  Author of last commit         #
#  $Date::                             $:  Date of last commit           #
#                                                                        #
##########################################################################

.PHONY: config byte opt clean superclean install tar version release

BINARIES=acgc acgc.opt acg acg.opt

VERSION_FILE = src/utils/version.ml
VERSION = $(shell date "+%Y%m%d")
RELEASE = acg-$(VERSION)

TAR_RELEASE =acg-$(TAR_VERSION)



prefix = @prefix@
exec_prefix = @exec_prefix@

byte opt: 
	$(MAKE) -C src $@ && for file in $(BINARIES); do find . -name "$$file" -exec cp {} . \; ; done

all: byte opt

clean:
	-if test "$@" = clean ; then $(MAKE) -C config $@ ; fi
	-$(MAKE) -C src $@
	rm -rf *.log  *~ autom4te.cache *.tar.gz
	find . -name "*~" -exec rm -f {} \;
	-for file in $(BINARIES); do rm $$file ; done

superclean: clean
	-find . -path "./*/*.in" -print | sed -e 's/\(.*\)\.in/\1/' | xargs -n 1 rm

install:
	for file in $(BINARIES); do if test -x $$file ; then cp $$file @bindir@/. ; fi ; done

uninstall:
	for file in $(BINARIES); do if test -x @bindir@/$$file ; then rm @bindir@/$$file ; fi ; done


# Part for the auto configuration

config: configure

configure: config/configure.ac
	cd $(<D) && autoconf && mv configure .. & cd ..

tar: TAR_VERSION = $(shell grep "^DEFINE" $(VERSION_FILE) | sed -e 's/DEFINE.* = "\(.*\)"/\1/')

tar: superclean
	if test -a ../$(TAR_RELEASE) ; then rm ../$(TAR_RELEASE) ; fi
	cd .. && ln -s trunk $(TAR_RELEASE) && cd trunk
	echo $(TAR_RELEASE).tar.gz
	tar cvfz $(TAR_RELEASE).tar.gz -C .. -h $(TAR_RELEASE) --exclude="*\.svn*" --exclude "$(TAR_RELEASE)/data" --exclude "$(TAR_RELEASE)/src/data" --exclude "$(TAR_RELEASE)/src/*.old" --exclude "$(TAR_RELEASE)/*.tar*"
	if test -a ../$(TAR_RELEASE) ; then rm ../$(TAR_RELEASE) ; fi
	./configure

version :
	sed -i 's/\(VERSION = \)".*"/\1"$(VERSION)"/' $(VERSION_FILE)

release : version tar
	if svn status -q -u | grep -v "^Status against" | grep -q -v "^\?" ; then printf "\n\nERROR:\nPlease commit before making a release\n\n" ; else svn cp svn+ssh://pogodall@scm.gforge.inria.fr/svn/acg/dev/trunk svn+ssh://pogodall@scm.gforge.inria.fr/svn/acg/dev/tags/release-$(VERSION) -m "Tagging the $(VERSION) release of the 'acg' project" ; cp acg-$(VERSION).tar.gz ~/www-acg/software/. ; cp INSTALL ~/www-acg/software/. ; cp README ~/www-acg/software/. ; sed -i -e 's/acg-[0-9]*\.tar\.gz/acg-$(VERSION).tar.gz/' ~/www-acg/index.html ;fi